$INCLUDE "RefTorch";

$ENTRY Go {
  = <Main>;
}

Main {
  = <Prout 'Testing RoPE...'>
    <DoRoPE>;
}

DoRoPE {
  = /* 1. Precompute Freqs for HeadDim=4, MaxSeq=10, Theta=10000.0 */
    <TPrecomputeFreqs 4 10 10000> : s.Freqs
    <Prout 'Freqs Shape (Should be [10, 2, 2]):'>
    <Prout <TShape s.Freqs>>
    
    /* 2. Create Dummy Query: [Batch=1, Seq=2, Heads=1, Dim=4] */
    <TOnes (1 2 1 4)> : s.Q
    <Prout 'Input Q Shape:'>
    <Prout <TShape s.Q>>
    
    /* 3. Apply RoPE */
    /* Note: We must slice Freqs to match Q's sequence length (2) */
    /* Slice dim 0 (seq), start 0, end 2, step 1 */
    <TSlice s.Freqs 0 0 2 1> : s.FreqsSliced
    
    <TRoPE s.Q s.FreqsSliced> : s.Rotated
    <Prout 'Rotated Q:'>
    <TPrint s.Rotated>
    
    <TFreeAll>;
}
